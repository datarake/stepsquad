name: Deploy StepSquad to Cloud Run

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGION: us-central1
  AR_REPO: stepsquad

jobs:
  deploy-api:
    name: Deploy Backend API
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Verify authentication
        run: |
          echo "Verifying gcloud authentication..."
          gcloud auth list
          gcloud config list
          
          if ! gcloud auth list --filter=status:ACTIVE --format="value(account)" | grep -q .; then
            echo "Error: No active gcloud account found"
            exit 1
          fi
      
      - name: Set project
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          if [ -z "$GCP_PROJECT_ID" ]; then
            echo "Error: GCP_PROJECT_ID secret is not set or empty"
            echo "Please verify the secret exists in GitHub Settings â†’ Secrets â†’ Actions"
            exit 1
          fi
          echo "Project ID: $GCP_PROJECT_ID"
          gcloud config set project "$GCP_PROJECT_ID"
          gcloud config list
      
      - name: Enable Artifact Registry API (if permissions allow)
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          gcloud services enable artifactregistry.googleapis.com --project=$PROJECT_ID 2>&1 | grep -v "PERMISSION_DENIED" || echo "â„¹ï¸  API may already be enabled or requires manual activation (non-fatal)"
      
      - name: Create Artifact Registry repository if not exists
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          if gcloud artifacts repositories describe ${{ env.AR_REPO }} --location=${{ env.REGION }} --project=$PROJECT_ID 2>/dev/null; then
            echo "âœ… Artifact Registry repository already exists: ${{ env.AR_REPO }}"
          else
            echo "Creating Artifact Registry repository: ${{ env.AR_REPO }}"
            if gcloud artifacts repositories create ${{ env.AR_REPO }} \
              --repository-format=docker \
              --location=${{ env.REGION }} \
              --project=$PROJECT_ID 2>&1; then
              echo "âœ… Repository created successfully"
            else
              echo "âš ï¸  WARNING: Failed to create repository (permissions issue)"
              echo "ðŸ“– See SETUP_ARTIFACT_REGISTRY.md for manual creation instructions"
              echo "â„¹ï¸  Repository may already exist or needs to be created manually by project owner"
            fi
          fi
      
      - name: Build API Image
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          if [ -z "$PROJECT_ID" ]; then
            echo "Error: PROJECT_ID is not set"
            exit 1
          fi
          cd apps/api
          gcloud builds submit --tag ${{ env.REGION }}-docker.pkg.dev/$PROJECT_ID/${{ env.AR_REPO }}/api:${{ github.sha }}
      
      - name: Deploy to Cloud Run
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          gcloud run deploy stepsquad-api \
            --image ${{ env.REGION }}-docker.pkg.dev/$PROJECT_ID/${{ env.AR_REPO }}/api:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --set-env-vars="GCP_ENABLED=true,GOOGLE_CLOUD_PROJECT=$PROJECT_ID,COMP_TZ=Europe/Bucharest,BQ_DATASET=stepsquad,PUBSUB_TOPIC_INGEST=steps.ingest,GRACE_DAYS=2" \
            --port 8080 \
            --memory 512Mi \
            --cpu 1

  deploy-web:
    name: Deploy Frontend Web
    runs-on: ubuntu-latest
    needs: deploy-api
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Verify authentication
        run: |
          echo "Verifying gcloud authentication..."
          gcloud auth list
          gcloud config list
          
          if ! gcloud auth list --filter=status:ACTIVE --format="value(account)" | grep -q .; then
            echo "Error: No active gcloud account found"
            exit 1
          fi
      
      - name: Set project
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          if [ -z "$GCP_PROJECT_ID" ]; then
            echo "Error: GCP_PROJECT_ID secret is not set or empty"
            echo "Please verify the secret exists in GitHub Settings â†’ Secrets â†’ Actions"
            exit 1
          fi
          echo "Project ID: $GCP_PROJECT_ID"
          gcloud config set project "$GCP_PROJECT_ID"
          gcloud config list
      
      - name: Get API URL
        id: get-api-url
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          # Try custom domain first, fallback to Cloud Run URL
          API_URL="https://api.stepsquad.club"
          # Verify custom domain is accessible, otherwise use Cloud Run URL
          if ! curl -sf --max-time 5 "${API_URL}/health" > /dev/null 2>&1; then
            echo "âš ï¸  Custom domain not yet accessible, using Cloud Run URL"
            API_URL=$(gcloud run services describe stepsquad-api --region ${{ env.REGION }} --format 'value(status.url)')
          fi
          echo "Using API URL: $API_URL"
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
      
      - name: Build Web Image
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          VITE_API_BASE_URL: ${{ steps.get-api-url.outputs.api_url }}
          VITE_USE_DEV_AUTH: 'false'
        run: |
          if [ -z "$PROJECT_ID" ]; then
            echo "Error: PROJECT_ID is not set"
            exit 1
          fi
          cd apps/web
          # Create .env.production with build-time variables
          echo "VITE_API_BASE_URL=${{ steps.get-api-url.outputs.api_url }}" > .env.production
          echo "VITE_USE_DEV_AUTH=false" >> .env.production
          gcloud builds submit --tag ${{ env.REGION }}-docker.pkg.dev/$PROJECT_ID/${{ env.AR_REPO }}/web:${{ github.sha }}
      
      - name: Deploy to Cloud Run
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          gcloud run deploy stepsquad-web \
            --image ${{ env.REGION }}-docker.pkg.dev/$PROJECT_ID/${{ env.AR_REPO }}/web:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --port 8080 \
            --memory 256Mi \
            --cpu 1

  deploy-workers:
    name: Deploy Workers
    runs-on: ubuntu-latest
    needs: deploy-api
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Set project
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          if [ -z "$GCP_PROJECT_ID" ]; then
            echo "Error: GCP_PROJECT_ID secret is not set or empty"
            exit 1
          fi
          gcloud config set project "$GCP_PROJECT_ID"
      
      - name: Build Workers Image
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          cd apps/workers
          gcloud builds submit --tag ${{ env.REGION }}-docker.pkg.dev/$PROJECT_ID/${{ env.AR_REPO }}/workers:${{ github.sha }}
      
      - name: Deploy to Cloud Run
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          gcloud run deploy stepsquad-workers \
            --image ${{ env.REGION }}-docker.pkg.dev/$PROJECT_ID/${{ env.AR_REPO }}/workers:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --no-allow-unauthenticated \
            --set-env-vars="GCP_ENABLED=true,GOOGLE_CLOUD_PROJECT=$PROJECT_ID,BQ_DATASET=stepsquad,PUBSUB_SUB_INGEST=steps.ingest.sub" \
            --port 8080 \
            --memory 512Mi \
            --cpu 1

  deploy-agents:
    name: Deploy Agents
    runs-on: ubuntu-latest
    needs: deploy-api
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Set project
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          if [ -z "$GCP_PROJECT_ID" ]; then
            echo "Error: GCP_PROJECT_ID secret is not set or empty"
            exit 1
          fi
          gcloud config set project "$GCP_PROJECT_ID"
      
      - name: Build Agents Image
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          cd apps/agents
          gcloud builds submit --tag ${{ env.REGION }}-docker.pkg.dev/$PROJECT_ID/${{ env.AR_REPO }}/agents:${{ github.sha }}
      
      - name: Deploy to Cloud Run
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          gcloud run deploy stepsquad-agents \
            --image ${{ env.REGION }}-docker.pkg.dev/$PROJECT_ID/${{ env.AR_REPO }}/agents:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --no-allow-unauthenticated \
            --set-env-vars="GCP_ENABLED=true,GOOGLE_CLOUD_PROJECT=$PROJECT_ID" \
            --port 8080 \
            --memory 512Mi \
            --cpu 1

  test-deployment:
    name: Test Deployment
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-web, deploy-workers, deploy-agents]
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Verify authentication
        run: |
          echo "Verifying gcloud authentication..."
          gcloud auth list
          gcloud config list
          
          if ! gcloud auth list --filter=status:ACTIVE --format="value(account)" | grep -q .; then
            echo "Error: No active gcloud account found"
            exit 1
          fi
      
      - name: Set project
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          if [ -z "$GCP_PROJECT_ID" ]; then
            echo "Error: GCP_PROJECT_ID secret is not set or empty"
            echo "Please verify the secret exists in GitHub Settings â†’ Secrets â†’ Actions"
            exit 1
          fi
          echo "Project ID: $GCP_PROJECT_ID"
          gcloud config set project "$GCP_PROJECT_ID"
          gcloud config list
      
      - name: Get URLs
        id: get-urls
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          API_URL=$(gcloud run services describe stepsquad-api --region ${{ env.REGION }} --format 'value(status.url)')
          WEB_URL=$(gcloud run services describe stepsquad-web --region ${{ env.REGION }} --format 'value(status.url)')
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "web_url=$WEB_URL" >> $GITHUB_OUTPUT
      
      - name: Test API Health
        run: |
          curl -f ${{ steps.get-urls.outputs.api_url }}/health || exit 1
      
      - name: Test Frontend
        run: |
          curl -f ${{ steps.get-urls.outputs.web_url }} || exit 1
